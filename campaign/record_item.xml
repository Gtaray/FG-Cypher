<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>
	<template name="button_itemtype">
		<button_stringcycler name="type">
			<anchored width="80" />
			<parameters>
				<defaultlabel>-</defaultlabel>
				<labelsres>char_label_invtypecypher|char_label_invtypeartifact|char_label_invtypeoddity|char_label_invtypeweapon|char_label_invtypearmor</labelsres>
				<values>cypher|artifact|oddity|weapon|armor</values>
			</parameters>
		</button_stringcycler>
	</template>

	<windowclass name="item" copy="record_window">
		<minimize>minimized_item</minimize>
		<script>
			function onLockChanged()
				super.onLockChanged();

				if actions.subwindow then
					actions.subwindow.update();
				end
			end
		</script>
		<sheetdata>
			<sub_record_header name="header">
				<class>item_header</class>
			</sub_record_header>

			<subwindow_record name="content">
				<class>item_main</class>
				<activate />
			</subwindow_record>
			<subwindow_record name="actions">
				<class>item_actions</class>
			</subwindow_record>

			<scrollbar_record>
				<target>content</target>
			</scrollbar_record>

			<tabs_recordsheet name="tabs">
				<gmvisibleonly />
				<tab>
					<icon>tab_main</icon>
					<subwindow>content</subwindow>
				</tab>
				<tab>
					<icon>tab_actions</icon>
					<subwindow>actions</subwindow>
				</tab>
			</tabs_recordsheet>
		</sheetdata>
	</windowclass>

	<windowclass name="item_main">
		<script file="campaign/scripts/item_main.lua" />
		<sheetdata>
			<anchor_column name="columnanchor" />
			
			<label_column name="nonid_name_label">
				<static textres="item_label_unidentified" />
			</label_column>
			<string_columnh name="nonid_name" />
			
			<label_column name="nonid_notes_label">
				<static textres="item_label_unidentifiednotes" />
			</label_column>
			<string_columnh name="nonid_notes" />
			
			<line_column name="divider" />

			<label_column name="type_label">
				<static textres="item_label_type" />
			</label_column>
			<button_itemtype name="type">
				<anchored>
					<top parent="columnanchor" anchor="bottom" relation="relative" offset="7" />
					<left offset="97" />
				</anchored>
				<script>
					function onValueChanged()
						window.update();
					end
				</script>
			</button_itemtype>

			<label_column name="cost_label">
				<static textres="item_label_cost" />
			</label_column>
			<string_columnh name="cost" />
			
			<!-- WEAPONS -->
			<label_column name="weapontype_label">
				<static textres="char_label_weapontype" />
			</label_column>
			<cycler_column name="weapontype">
				<anchored width="80" />
				<parameters>
					<labelsres>item_weapontypelight|item_weapontypemedium|item_weapontypeheavy</labelsres>
					<values>light|medium|heavy</values>
					<defaultlabelres>dash</defaultlabelres>
				</parameters>
				<script>
					function onValueChanged()
						window.update();
						window.updateDamageValue();
					end
				</script>
			</cycler_column>

			<header_column name="header_attack">
				<static textres="item_header_attack" />
				<center />
			</header_column>
			<label_column name="attackstat_label">
				<static textres="item_label_attackstat" />
			</label_column>
			<column_stat name="attackstat">
				<anchored width="80" />
				<tooltip textres="item_tooltip_attackstat" />
			</column_stat>
			<label_column name="defensestat_label">
				<static textres="item_label_defensestat" />
			</label_column>
			<column_stat name="defensestat">
				<anchored width="80" />
				<tooltip textres="item_tooltip_defensestat" />
			</column_stat>
			<label_column name="atkrange_label">
				<static textres="item_label_attackrange" />
			</label_column>
			<column_range name="atkrange">
				<anchored width="80" />
				<tooltip textres="item_tooltip_attackrange" />
			</column_range>
			<label_column name="asset_label">
				<static textres="item_label_asset" />
			</label_column>
			<number_column name="asset">
				<hideonvalue value="0" />
				<min>0</min>
				<max>2</max>
			</number_column>
			<label_column name="modifier_label">
				<static textres="item_label_modifier" />
			</label_column>
			<number_column name="modifier">
				<hideonvalue value="0" />
			</number_column>

			<header_column name="header_damage">
				<static textres="item_header_damage" />
				<center />
			</header_column>
			<label_column name="damagestat_label">
				<static textres="item_label_damagestat" />
			</label_column>
			<column_stat name="damagestat">
				<anchored width="80" />
				<tooltip textres="item_tooltip_damagestat" />
			</column_stat>
			<label_column name="damage_label">
				<static textres="item_label_damage" />
			</label_column>
			<number_columnh name="damage" />
			<label_column name="pierce_label">
				<static textres="item_label_pierce" />
			</label_column>
			<cycler_column name="pierce">
				<anchored width="80" />
				<script>
					function onValueChanged()
						if super and super.onValueChanged then
							super.onValueChanged()
						end
						window.onPierceChanged();
					end
				</script>
				<parameters>
					<labelsres>yes</labelsres>
					<values>yes</values>
					<defaultlabel>No</defaultlabel>
				</parameters>
				<tooltip textres="power_tooltip_pierce_armor" />
			</cycler_column>
			<basicnumber name="pierceamount">
				<anchored to="pierce" position="righthigh" offset="10,0" width="30" height="20" />
				<min>0</min>
				<tooltip textres="item_tooltip_pierceamount" />
			</basicnumber>

			<!-- ARMOR -->
			<label_column name="armortype_label">
				<static textres="item_label_armortype" />
			</label_column>
			<cycler_column name="armortype">
				<anchored width="80" />
				<parameters>
					<labelsres>item_armortypelight|item_armortypemedium|item_armortypeheavy|item_armortypeshield</labelsres>
					<values>light|medium|heavy|shield</values>
					<defaultlabelres>dash</defaultlabelres>
				</parameters>
				<script>
					function onValueChanged()
						window.update();
						window.updateArmorValue();
					end
				</script>
			</cycler_column>
			<label_column name="armor_label">
				<static textres="item_label_armor" />
			</label_column>
			<number_columnh name="armor" />
			<label_column name="shieldbonus_label">
				<static textres="item_label_shieldbonus" />
			</label_column>
			<cycler_column name="shieldbonus">
				<anchored width="120" />
				<parameters>
					<labelsres>item_shieldbonus_1|item_shieldbonus_2</labelsres>
					<values>1|2</values>
					<defaultlabelres>dash</defaultlabelres>
				</parameters>
			</cycler_column>

			<label_column name="levelroll_label">
				<static textres="item_label_levelroll" />
			</label_column>
			<string_columnh name="levelroll">
				<default>1d6</default>
			</string_columnh>
			
			<label_column name="level_label">
				<static textres="item_label_level" />
			</label_column>
			<number_columnh name="level" />
			
			<label_column name="depletion_label">
				<static textres="item_label_depletion" />
			</label_column>
			<number_columnh name="depletion">
				<rollable />
				<script>
					function update(bReadOnly, bForceHide)
						super.update(bReadOnly, bForceHide);
						window.depletiondie.setVisible(isVisible());
					end

					function onDoubleClick(x, y)
						window.actionDepletion();
						return true;
					end

					function onDragStart(button, x, y, draginfo)
						window.actionDepletion(draginfo);
						return true;
					end
				</script>
			</number_columnh>
			<label name="depletiondie_label">
				<anchored to="depletion" position="righthigh" offset="10,0" />
				<static textres="item_label_depletionin" />
			</label>
			<button_stringcycler name="depletiondie">
				<anchored to="depletiondie_label" position="righthigh" offset="10,0" height="20" width="40" />
				<frame name="fielddark" offset="7,5,7,5" />
				<stateframe>
					<hover name="fieldfocus" offset="7,5,7,5" hidereadonly="true" />
				</stateframe>
				<parameters>
					<labels>1d6|1d10|1d20|1d100</labels>
					<values>d6|d10|d20|d100</values>
					<defaultlabel>-</defaultlabel>
				</parameters>
			</button_stringcycler>
			
			<line_column name="divider2" />

			<ft_columnh name="notes" />
		</sheetdata>
	</windowclass>

	<!-- ACTIONS -->
	<windowclass name="item_actions">
		<margins control="0,0,0,2" />
		<script>
		function onInit()    
			update();
		end

		function onClose()
		end

		function updateControl(sControl, bReadOnly, bForceHide)
			if not self[sControl] then
				return false;
			end
			
			return self[sControl].update(bReadOnly, bForceHide);
		end

		function update()
			local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
			if bReadOnly then
				actions_iedit.setValue(0);
			end

			actions_iedit.setVisible(not bReadOnly)
			attack_iadd.setVisible(not bReadOnly)
			damage_iadd.setVisible(not bReadOnly)
			heal_iadd.setVisible(not bReadOnly)
			effect_iadd.setVisible(not bReadOnly)
		end
		</script>
		<sheetdata>
			<anchor_column name="columnanchor" />
			<label name="header_actions">
				<anchored height="20">
					<top parent="columnanchor" anchor="bottom" relation="relative" offset="10" />
					<left offset="10" />
					<right offset="-10" />
				</anchored>
				<frame name="headersimple" offset="10,3,10,3" />
				<static textres="power_header_properties" />
			</label>

			<button_iedit name="actions_iedit">
				<anchored position="insidetopright" offset="10,5" />
				<target>actions</target>
			</button_iedit>
			<buttoncontrol name="effect_iadd">
				<anchored to="actions_iedit" position="lefthigh" offset="5,0" width="20" height="20" />
				<icon normal="button_action_effect" pressed="button_action_effect_down" />
				<script>
					function onButtonPress()
						window.actions.addEntry("effect", true);
					end
				</script>
			</buttoncontrol>
			<buttoncontrol name="heal_iadd">
				<anchored to="effect_iadd" position="lefthigh" offset="5,0" width="20" height="20" />
				<icon normal="button_action_heal" pressed="button_action_heal_down" />
				<script>
					function onButtonPress()
						window.actions.addEntry("heal", true);
					end
				</script>
			</buttoncontrol>
			<buttoncontrol name="damage_iadd">
				<anchored to="heal_iadd" position="lefthigh" offset="5,0" width="20" height="20" />
				<icon normal="button_action_damage" pressed="button_action_damage_down" />
				<script>
					function onButtonPress()
						window.actions.addEntry("damage", true);
					end
				</script>
			</buttoncontrol>
			<buttoncontrol name="attack_iadd">
				<anchored to="damage_iadd" position="lefthigh" offset="5,0" width="20" height="20" />
				<icon normal="button_action_attack" pressed="button_action_attack_down" />
				<script>
					function onButtonPress()
						window.actions.addEntry("attack", true);
					end
				</script>
			</buttoncontrol>
			<buttoncontrol name="stat_iadd">
				<anchored to="attack_iadd" position="lefthigh" offset="5,0" width="20" height="20" />
				<icon normal="button_roll" pressed="button_roll_down" />
				<script>
					function onButtonPress()
						window.actions.addEntry("stat", true);
					end
				</script>
			</buttoncontrol>

			<list_poweraction name="actions">
				<script>
					function update()
						local bEditMode = (window.actions_iedit.getValue() == 1);
						
						for _,w in ipairs(getWindows()) do
							w.idelete.setVisibility(bEditMode);
						end
					end

					function addEntry(sType, bFocus)
						local nodelist = getDatabaseNode();
						if nodelist then
							local nodeAction = nodelist.createChild();
							if nodeAction then
								DB.setValue(nodeAction, "type", "string", sType);
							end
						end

						update();
					end

					function reset()
						for _,v in pairs(getWindows()) do
							v.getDatabaseNode().delete();
						end
					end

					function setOrder(node)
						if DB.getValue(node, "order", 0) == 0 then
							local aOrder = {};
							for _,v in pairs(DB.getChildren(getDatabaseNode(), "")) do
								aOrder[DB.getValue(v, "order", 0)] = true;
							end
							
							local i = 1;
							while aOrder[i] do
								i = i + 1;
							end
							
							DB.setValue(node, "order", "number", i);
						end
					end
				</script>
				<anchored>
					<top parent="header_actions" anchor="bottom" relation="relative" offset="5" />
					<left offset="20" />
					<right offset="-20" />
				</anchored>
			</list_poweraction>
			<scrollbar>
				<anchored to="actions" />
				<target>actions</target>
			</scrollbar>
		</sheetdata>
	</windowclass>
</root>
