<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>
	<!-- TEMPLATES FOR MAIN TAB -->
	<template name="button_charclasslevel">
		<button_details>
			<script>
				function onButtonPress()
					Interface.openWindow("charsheet_statement_editor", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>
	<template name="stringc_charstatement">
		<stringcu>
			<anchored >
				<top anchor="bottom" relation="relative" offset="5" />
				<left offset="5" postoffset="5" />
				<right offset="-5" postoffset="-5" />
			</anchored>
			<readonly />
			<multilinespacing>20</multilinespacing>
			<script>
				function onInit()
					update();
					local node = window.getDatabaseNode();
					DB.addHandler(DB.getPath(node, "name"), "onUpdate", update);
					DB.addHandler(DB.getPath(node, "class"), "onChildUpdate", update);
				end
				function onClose()
					local node = window.getDatabaseNode();
					DB.addHandler(DB.getPath(node, "name"), "onUpdate", update);
					DB.removeHandler(DB.getPath(node, "class"), "onChildUpdate", update);
				end
				function update()
					setValue(CharManager.getCharacterStatement(window.getDatabaseNode()));
				end
				function onClickDown(button, x, y)
					return true;
				end
				function onClickRelease(button, x, y)
					Interface.openWindow("charsheet_statement_editor", window.getDatabaseNode());
				end
			</script>
		</stringcu>
	</template>

	<template name="sub_char_statpool">
		<subwindow>
			<script>
				function onInit()
					local sStat;
					if stat and stat[1] then
						sStat = stat[1]
					end

					local nodeActor = window.getDatabaseNode();
					if sStat and nodeActor then
						local sNodePath = DB.getPath(nodeActor, "stats", sStat)
						DB.createNode(sNodePath)
						setValue("charsheet_statpool", sNodePath)
					end
				end
			</script>
			<anchored width="160" />
			<activate />
			<class>charsheet_statpool</class>
		</subwindow>
	</template>

	<template name="title_stat">
		<label_charframetop>
			<anchored height="20">
				<top />
				<left offset="15" />
				<right offset="-15" />
			</anchored>
			<icons>char_class</icons>
		</label_charframetop>
	</template>
	<template name="number_charabilitypool">
		<basicnumber>
			<font>char_pool</font>
			<default>10</default>
			<min>0</min>
			<droptypes>
				<type>number</type>
				<type>recovery</type>
			</droptypes>
			<rollable />
			<script file="campaign/scripts/char_ability_pool.lua" />
			<anchored position="belowleft" offset="10,20" width="60" height="50" />
		</basicnumber>
	</template>
	<template name="number_charabilitymax">
		<basicnumber>
			<default>10</default>
			<min>0</min>
			<readonly />
			<anchored width="30" height="20">
				<top />
				<left position="right" relation="relative" offset="12" />
			</anchored>
		</basicnumber>
	</template>
	<template name="number_charedge">
		<basicnumber>
			<anchored width="30" height="20">
				<top />
				<left position="right" relation="relative" offset="20" />
			</anchored>
			<min>0</min>
			<max>6</max>
		</basicnumber>
	</template>
	<template name="button_statdetails">
		<button_details name="details">
			<anchored position="insidetopright" />
			<script>					
				function onButtonPress()
					Interface.openWindow("charsheet_statpool_editor", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>
	<template name="button_statpool_defenseroll">
		<button_defenseroll>
			<script file="campaign/scripts/button_defenseroll.lua" />
		</button_defenseroll>
	</template>
	<template name="label_defenseroll">
		<label>
			<anchored position="lefthigh" offset="5,2" />
			<static textres="char_label_statdef" />
		</label>
	</template>
	<template name="button_defensetraining">
		<button_training_base>
			<anchored position="righthigh" offset="7,0" />
		</button_training_base>
	</template>

	<template name="number_chartotalarmor">
		<number_linked_framed>
			<tooltip textres="char_tooltip_armor" />
			<font>reference-b-large</font>
			<source><name>defenses.armor.base</name><op>+</op></source>
			<source><name>defenses.armor.mod</name><op>+</op></source>
		</number_linked_framed>
	</template>
	<template name="number_charinit">
		<number_linked_framed>
			<tooltip textres="char_tooltip_initiative" />
			<font>reference-b-large</font>
			<rollable />
			<displaysign />
			<source><name>initiative.assets</name><op>+</op></source>
			<source><name>initiative.mod</name><op>+</op></source>
			<source><name>initiative.training</name><op>+</op></source>
			<script>
				function onSourceUpdate()
					local rActor = ActorManager.resolveActor(window.getDatabaseNode());
					local sTraining, nAssets, nModifier = ActorManagerCypher.getInitiative(rActor);
					setValue(RollManager.convertToFlatBonus(sTraining, nAssets, nModifier));
				end
				function action(draginfo)
					local rActor = ActorManager.resolveActor(window.getDatabaseNode());
					local rAction = {};
					rAction.sStat = "speed";
					rAction.sTraining, rAction.nAssets, rAction.nModifier = ActorManagerCypher.getInitiative(rActor);
					ActionInit.payCostAndRoll(draginfo, rActor, rAction);
				end
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
				function onDoubleClick(x,y)
					return action();
				end
			</script>
		</number_linked_framed>
	</template>
	<template name="button_inittraining">
		<button_training_base>
			<anchored position="insidebottomright" offset="-10,-10" height="20" width="20" />
			<readonly />
		</button_training_base>
	</template>
	<template name="number_chareffort">
		<number_linked_framed>
			<tooltip textres="char_tooltip_effort" />
			<font>reference-b-large</font>
			<source><name>effort.base</name><op>+</op></source>
			<source><name>effort.mod</name><op>+</op></source>
		</number_linked_framed>
	</template>
	<template name="icon_armorpenalty">
		<genericcontrol>
			<script>
				function onInit()
					setColor(ColorManager.getUIColor("usage_full"))
					local node = window.getDatabaseNode();
					DB.addHandler(DB.getPath(node, "effort.armorpenalty.total"), "onUpdate", update);
					DB.addHandler(DB.getPath(node, "health.damagetrack"), "onUpdate", update);
					update();
				end
				function onClose()
					local node = window.getDatabaseNode();
					DB.removeHandler(DB.getPath(node, "effort.armorpenalty.total"), "onUpdate", update);
					DB.removeHandler(DB.getPath(node, "health.damagetrack"), "onUpdate", update);
				end
				function update()
					local node = window.getDatabaseNode();
					local nCost = ActorManagerCypher.getArmorSpeedCost(node);
					local bImpaired = ActorManagerCypher.isImpaired(node);
					setVisible(nCost > 0 or bImpaired);
				end
			</script>
			<anchored position="insidebottomright" offset="-10,-10" width="20" height="20" />
			<disabled />
			<icon>armor_icon</icon>
		</genericcontrol>
	</template>
	<template name="button_charcombatcalc">
		<button_details>
			<anchored position="insidetopright" />
			<script>
				function onButtonPress()
					Interface.openWindow("charsheet_combat_editor", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>
	<template name="label_charfieldtop_expanded">
		<label_charfieldtop>
			<anchored>
				<bottom anchor="top" offset="-10" />
				<left offset="-8" />
				<right offset="8" />
			</anchored>
			<static textres="char_label_effort" />
		</label_charfieldtop>
	</template>

	<template name="list_char_resistances">
		<list_damagemods>
			<script>
				function update()
					local bEditMode = (window.resistances_iedit.getValue() == 1);
					if window.idelete_header then
						window.idelete_header.setVisible(bEditMode);
					end
					for _,w in ipairs(getWindows()) do
						w.idelete.setVisible(bEditMode);
					end
				end
			</script>
			<anchored>
				<top parent="specialdefensestitle" anchor="bottom" relation="relative" offset="5" />
				<left offset="10" />
				<right offset="-5" />
				<bottom offset="-10" />
			</anchored>
			<noscroll merge="delete" />
			<datasource>.defenses.resistances</datasource>
		</list_damagemods>
	</template>

	<template name="button_damagetrack">
		<buttongroup_counter>
			<anchored height="20">
				<top to="columnanchor" anchor="bottom" relation="relative" offset="10" />
				<left offset="0" />
			</anchored>
			<allowsinglespacing />
			<spacing>34</spacing>
			<maxslotperrow>3</maxslotperrow>
			<values>
				<maximum>3</maximum>
			</values>
			<sourcefields>
				<current>health.damagetrack</current>
			</sourcefields>
			<stateicons merge="replaceandadd">
				<on>button_bigcheckon</on>
				<off>button_bigcheckoff</off>
			</stateicons>
			<script file="campaign/scripts/char_damagetrack_counter.lua" />
		</buttongroup_counter>
	</template>
	<template name="label_damagetrackstatus">
		<label>
			<anchored position="righthigh" offset="10,0" width="80" height="20" />
			<frame name="fieldlight" offset="7,5,7,5" />
			<static textres="status_hale" />
			<center />
		</label>
	</template>
	<template name="button_damagetrackdetails">
		<button_details name="details">
			<anchored position="insidetopright" />
			<script>					
				function onButtonPress()
					Interface.openWindow("charsheet_damagetrack_editor", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>

	<template name="button_recoveries">
		<buttongroup_counter>
			<anchored height="20">
				<top to="columnanchor" anchor="bottom" relation="relative" offset="10" />
				<left offset="0" />
			</anchored>
			<allowsinglespacing />
			<spacing>34</spacing>
			<maxslotperrow>4</maxslotperrow>
			<values>
				<maximum>4</maximum>
			</values>
			<sourcefields>
				<current>health.recovery.used</current>
			</sourcefields>
			<stateicons merge="replaceandadd">
				<on>button_bigcheckon</on>
				<off>button_bigcheckoff</off>
			</stateicons>
			<script file="campaign/scripts/char_recovery_counter.lua" />
		</buttongroup_counter>
	</template>
	<template name="label_recoverystatus">
		<label>
			<anchored position="below" offset="0,5" height="20" />
			<frame name="fieldlight" offset="7,5,7,5" />
			<static textres="char_label_recovery1action" />
			<center />
		</label>
	</template>
	<template name="number_charrecovery">
		<number_linked_framed>
			<tooltip textres="char_tooltip_recoverytotal" />
			<font>reference-b-large</font>
			<rollable />
			<displaysign />
			<source><name>advancement.tier</name><op>+</op></source>
			<source><name>health.recovery.mod</name><op>+</op></source>
			<script>
				function action(draginfo)
					local rActor = ActorManager.resolveActor(window.getDatabaseNode());
					ActionRecovery.performRoll(draginfo, rActor, {});
				end
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
				function onDoubleClick(x,y)
					return action();
				end
			</script>
		</number_linked_framed>
	</template>
	<template name="button_recoverydetails">
		<button_details name="details">
			<anchored position="insidetopright" />
			<script>					
				function onButtonPress()
					Interface.openWindow("charsheet_recovery_editor", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>

	<template name="button_tracker">
		<button_details name="details">
			<anchored position="insidetopright" />
			<script>					
				function onButtonPress()
					Interface.openWindow("charsheet_tracker", window.getDatabaseNode());
				end
			</script>
		</button_details>
	</template>
	<template name="label_advancements">
		<stringcontrol>
			<anchored position="lefthigh" offset="2,0" />
			<font>sheetlabelmini</font>
		</stringcontrol>
	</template>
	<template name="header_advancements">
		<label_charfieldtop>
			<anchored merge="delete" />
			<anchored>
				<top parent="xp_label" offset="2" />
				<left parent="effort_label" />
				<right parent="adv_edge"/>
			</anchored>
		</label_charfieldtop>
	</template>

	<template name="sub_charhseet_statement_part">
		<subwindow>
			<script file="campaign/scripts/char_statement_part.lua" />
			<anchored to="contentanchor">
				<top anchor="bottom" relation="relative" offset="15" />
				<left />
				<right />
			</anchored>
			<class>charsheet_statement_part</class>
			<activate />
		</subwindow>
	</template>
	<template name="title_charstatement_editor">
		<label_charframetop>
			<anchored to="contentanchor" height="20">
				<top anchor="bottom" relation="relative" />
				<left offset="10" />
				<right offset="-10" />
			</anchored>
			<icons>char_class</icons>
		</label_charframetop>
	</template>
	<template name="charstatement_rightanchor">
		<genericcontrol to="title">
			<anchored>
				<top parent="contentanchor" anchor="bottom" relation="relative" offset="8" />
				<right />
			</anchored>
			<disabled />
		</genericcontrol>
	</template>
	<template name="charstatement_link">
		<linkfield_statich>
			<anchored to="rightanchor" width="20" height="20">
				<top offset="-2" />
				<right relation="relative" offset="-2" postoffset="-2" />
			</anchored>
		</linkfield_statich>
	</template>
	<template name="button_charstatement_iadd">
		<button_iadd_recordtype>
			<script>
				function onButtonPress()
					window.openRecordList();
				end
			</script>
			<anchored to="rightanchor">
				<top offset="-2" />
				<right relation="relative" offset="-2" postoffset="-2" />
			</anchored>
		</button_iadd_recordtype>
	</template>
	<template name="stringu_charstatement_editor">
		<stringu>
			<anchored to="rightanchor">
				<top />
				<left parent="contentanchor" offset="5" />
				<right anchor="left" relation="relative" offset="-5" />
			</anchored>
		</stringu>
	</template>

	<template name="button_advancement">
		<button_iadd_base>
			<anchored position="insidetopright" width="20" height="20" />
			<!-- This will eventually move the character to the next tier -->
			<!-- <script>	
				function onInit()
					local nodeActor = window.getDatabaseNode()
					DB.addHandler(DB.getPath(nodeActor, "advancement", "xp"), "onUpdate", onXpChanged)
					self.onXpChanged()
				end	
				function onClose()
					local nodeActor = window.getDatabaseNode()
					DB.removeHandler(DB.getPath(nodeActor, "advancement", "xp"), "onUpdate", onXpChanged)
				end	
				function onXpChanged()
					local nodeActor = window.getDatabaseNode()
					local nXp = DB.getValue(nodeActor, "advancement.xp", 0)
					setVisible(nXp &gt;= 4)
				end
				function onButtonPress()
					local rData = {
						nodeChar = window.getDatabaseNode()
					}
					CharManager.takeAdvancement(rData.nodeChar, "", rData)
				end
			</script> -->
			<tooltip textres="char_tooltip_advance_button" />
		</button_iadd_base>
	</template>
	<!-- END MAIN TAB -->

	<template name="sub_tab_maincharsheet">
		<subwindow>
			<anchored to="subwindowframe">
				<left offset="0" />
				<top offset="0" />
				<right offset="0" />
				<bottom offset="0" />
			</anchored>
		</subwindow>
	</template>

	<template name="button_statroll">
		<button_roll>
			<anchored width="25" height="25">
				<top offset="-8" />
				<left offset="-10" />
			</anchored>
			<script>
				function action(draginfo)
					local sStat = stat[1];
					if (sStat or "") == "" then
						return;
					end

					local rAction = {
						label = StringManager.capitalize(sStat),
						sStat = sStat
					}
					
					local rActor = ActorManager.resolveActor(window.getDatabaseNode())
					ActionStat.payCostAndRoll(draginfo, rActor, rAction);
				end

				function onButtonPress(x, y)
					action();
					return true;
				end
				function onDragStart(button, x, y, draginfo)
					action(draginfo);
					return true;
				end
			</script>
		</button_roll>
	</template>

	<template name="button_defensetraining">
		<button_skill>
			<anchored position="righthigh" offset="7,0" width="15" height="20" />
			<default>1</default>
		</button_skill>
	</template>
	<template name="number_defenseasset">
		<basicnumber>
			<anchored position="righthigh" offset="7,0" width="15" height="20" />
			<tooltip textres="assets" />
			<min>0</min>
			<max>2</max>
		</basicnumber>
	</template>
	<template name="number_defensemod">
		<basicnumber>
			<anchored position="righthigh" offset="7,0" width="15" height="20" />
			<tooltip textres="modifier" />
		</basicnumber>
	</template>

	<template name="button_training_base">
		<buttonfield>
			<anchored width="20" height="20" />
			<state icon="button_prof" tooltipres="char_tooltip_skillinability" merge="add" />
			<state icon="button_prof_half" tooltipres="char_tooltip_skilluntrained" merge="add" />
			<state icon="button_prof_down" tooltipres="char_tooltip_skilltrained" merge="add" />
			<state icon="button_prof_double" tooltipres="char_tooltip_skillspecialized" merge="add" />
			<default>1</default>
		</buttonfield>
	</template>

	<template name="button_skill">
		<button_listitem_left>
			<state icon="button_prof" tooltipres="char_tooltip_skillinability" merge="add" />
			<state icon="button_prof_half" tooltipres="char_tooltip_skilluntrained" merge="add" />
			<state icon="button_prof_down" tooltipres="char_tooltip_skilltrained" merge="add" />
			<state icon="button_prof_double" tooltipres="char_tooltip_skillspecialized" merge="add" />
			<default>2</default>
		</button_listitem_left>
	</template>

	<template name="button_weapontraining">
		<button_listitem_left>
			<state icon="button_prof" tooltipres="char_tooltip_skillinability" merge="add" />
			<state icon="button_prof_half" tooltipres="char_tooltip_skilluntrained" merge="add" />
			<state icon="button_prof_down" tooltipres="char_tooltip_skilltrained" merge="add" />
			<state icon="button_prof_double" tooltipres="char_tooltip_skillspecialized" merge="add" />
			<default>0</default>
		</button_listitem_left>
	</template>

	<template name="cycler_training">
		<button_stringcycler>
			<parameters>
				<labelsres>label_training_trained|label_training_specialized|label_training_inability</labelsres>
				<values>trained|specialized|inability</values>
				<defaultlabelres>label_training_practiced</defaultlabelres>
			</parameters>
		</button_stringcycler>
	</template>

	<template name="column_training">
		<cycler_training>
			<anchored width="160">
				<top parent="columnanchor" anchor="bottom" relation="relative" offset="7" />
				<left offset="97" />
			</anchored>
		</cycler_training>
	</template>

	<template name="cycler_range">
		<button_stringcycler>
			<script>
				function onInit()
					if super and super.onInit then
						super.onInit()
					end

					local sVal = DB.getValue(getDatabaseNode())
					if sVal == "Far" then
						setStringValue("Long")
					elseif sVal == "Very Far" then
						setStringValue("Very Long")
					end
				end
			</script>
			<parameters>
				<defaultlabelres>dash</defaultlabelres>
				<labelsres>power_label_rangeimmediate|power_label_rangeshort|power_label_rangelong|power_label_range200</labelsres>
				<values>Immediate|Short|Long|Very Long</values>
			</parameters>
		</button_stringcycler>
	</template>

	<template name="column_range">
		<cycler_range>
			<anchored>
				<top parent="columnanchor" anchor="bottom" relation="relative" offset="7" />
				<left offset="97" />
			</anchored>
		</cycler_range>
	</template>

	<template name="cycler_costtype">
		<cycler_column name="costtype">
			<anchored width="140" />
			<parameters>
				<labelsres>power_label_costtype_ability|power_label_costtype_fixed</labelsres>
				<values>ability|fixed</values>
				<defaultlabelres>dash</defaultlabelres>
			</parameters>
			<script>
				function onInit()
					super.onInit();
					onValueChanged();
				end
				function onValueChanged()
					window.updateCostType();
				end
			</script>
		</cycler_column>
	</template>

	<template name="button_skill_wide">
		<buttonfield>
			<frame name="fielddark" offset="7,5,7,5" hidereadonly="true" />
			<stateframe>
				<hover name="fieldfocus" offset="7,5,7,5" />
			</stateframe>
			<state textres="char_tooltip_skillinability" />
			<state textres="char_tooltip_skilluntrained" />
			<state textres="char_tooltip_skilltrained" />
			<state textres="char_tooltip_skillspecialized" />
		</buttonfield>
	</template>

    <template name="button_increase">
        <button_text_sm>
            <state text="&gt;" />
            <script>
                function onButtonPress()
                    window.onIncrease(stat[1]);
                end
            </script>
        </button_text_sm>
    </template>

	<template name="button_decrease">        
        <button_text_sm>
            <state text="&lt;" />
            <script>
                function onButtonPress()
                    window.onDecrease(stat[1]);
                end
            </script>
        </button_text_sm>        
    </template>

	<template name="button_use_power">
		<button_checkbox>
			<anchored to="leftanchor" width="20" height="10">
				<top offset="8" />
				<left anchor="right" relation="relative" />
			</anchored>
		</button_checkbox>
	</template>

	<template name="buttongroup_counter_power">
		<genericcontrol>
			<anchored to="leftanchor">
				<top offset="0" />
				<left anchor="right" relation="relative" />
			</anchored>
			<stateicons>
				<on>button_checkon</on>
				<off>button_checkoff</off>
			</stateicons>
			<spacing>12</spacing>
			<script file="campaign/scripts/buttongroup_counter_power.lua" />
		</genericcontrol>
	</template>

	<template name="state_charammocounter">
		<buttongroup_counter>
			<sourcefields>
				<maximum>maxammo</maximum>
				<current>ammo</current>
			</sourcefields>
			<maxslotperrow>30</maxslotperrow>
		</buttongroup_counter>
	</template>

	<template name="button_checkbox_advancement">
		<button_checkbox>
			<anchored to="xp" position="righthigh" width="12" height="12" />
			<script>
				local bProcessing = false
				function processAdvancement(fAdvFunc)
					if bProcessing then return end

					bProcessing = true

					if getValue() == 0 then 
						bProcessing = false
						return
					end

					if not fAdvFunc(window.getDatabaseNode()) then
						setValue(0)
					end

					bProcessing = false
				end
			</script>
		</button_checkbox>
	</template>

	<template name="list_charinv_cypher">
		<list_charinv name="inventorylist">
			<script file="campaign/scripts/char_invlist.lua" />
		</list_charinv>
	</template>

	<!-- Custom Stat Pools -->
	<template name="number_custom_stat_pool">
		<basicnumber>
			<anchored to="rightanchor" width="30" height="20">
				<top />
				<right anchor="left" relation="relative" offset="-5" />
			</anchored>
			<min>0</min>
		</basicnumber>
	</template>

	<template name="button_custom_stat_pool_statroll">
		<button_roll>
			<anchored to="rightanchor">
				<top />
				<right anchor="left" relation="relative" offset="-5" />
			</anchored>
			<script>
				function onDragStart(button, x, y, draginfo)
					action(draginfo)
					return true;
				end
				function onButtonPress()
					action()
				end
				function action(draginfo)
					local sStat = window.name.getValue()
					if (sStat or "") == "" then
						return;
					end

					local rAction = {
						label = StringManager.capitalize(sStat),
						sStat = sStat
					}
					
					local w = UtilityManager.getTopWindow(window);
					local rActor = ActorManager.resolveActor(w.getDatabaseNode())
					ActionStat.payCostAndRoll(draginfo, rActor, rAction);
				end
			</script>
		</button_roll>
	</template>

	<template name="button_custom_stat_pool_defroll">
		<button_defenseroll>
			<anchored to="rightanchor" height="20" width="20">
				<top />
				<right anchor="left" relation="relative" offset="-5" />
			</anchored>
			<script>
				function onDragStart(button, x, y, draginfo)
					action(draginfo)
					return true;
				end
				function onButtonPress()
					action()
				end
				function action(draginfo)
					local sStat = window.name.getValue()
					if (sStat or "") == "" then
						return;
					end

					local rAction = {
						label = StringManager.capitalize(sStat),
						sStat = sStat
					}
					
					local w = UtilityManager.getTopWindow(window);
					local rActor = ActorManager.resolveActor(w.getDatabaseNode())
					ActionDefense.payCostAndRoll(draginfo, rActor, rAction);
				end
			</script>
		</button_defenseroll>
	</template>

	<template name="button_iadd_recordtype">
		<button_iadd_base>
			<script>
				function onButtonPress()
					RecordManager.openRecordIndex(recordtype[1])
				end
			</script>
		</button_iadd_base>
	</template>

	<template name="button_defenseroll">
		<button_roll>
			<anchored width="25" height="25" />
			<icon normal="button_action_defend" pressed="button_action_defend_down" />
		</button_roll>
	</template>
</root>
