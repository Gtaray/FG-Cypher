<?xml version="1.0" encoding="utf-8"?>
<root version="3.3" release="1.0">
	<windowclass name="damage_modification">
		<margins control="0,0,0,2" />
		<script>
			function update(bReadOnly)
				damagetype.setReadOnly(bReadOnly);
				type.setReadOnly(bReadOnly);
				amount.setReadOnly(bReadOnly);
			end
		</script>
		<sheetdata>
			<genericcontrol name="rightanchor">
				<anchored position="insidetopright" offset="0,2" height="0" width="0" />
				<invisible />
			</genericcontrol>
			<button_idelete name="idelete">
				<anchored to="rightanchor">
					<top />
					<right anchor="left" offset="-5" />
				</anchored>
			</button_idelete>
			<basicnumber name="amount">
				<anchored to="rightanchor" relation="relative" height="20" width="30">
					<top />
					<right anchor="left" relation="relative" offset="-35" />
				</anchored>
				<min>0</min>
			</basicnumber>
			<button_stringcycler name="type">
				<anchored to="rightanchor" width="80">
					<top />
					<right anchor="left" relation="relative" offset="-10" />
				</anchored>  
				<parameters>
					<labelsres>damage_modification_resistance|damage_modification_immunity|damage_modification_vulnerability</labelsres>
					<values>resist|immune|vuln</values>
					<defaultlabelres>dash</defaultlabelres>
				</parameters>
			</button_stringcycler>
			<stringu_damagetype_autocomplete name="damagetype">
				<anchored to="rightanchor" height="20">
					<top />
					<left parent="" offset="5" />
					<right anchor="left" relation="relative" offset="-10" />
				</anchored>
			</stringu_damagetype_autocomplete>
		</sheetdata>
	</windowclass>

	<template name="list_damagemods">
		<list_column>
			<script>
				function onInit()
					if super and super.onInit then
						super.onInit()
					end
					OptionsManager.registerCallback("DMGTYPES", update);
					update();
				end
				function onClose()
					if super and super.onClose then
						super.onClose()
					end
					OptionsManager.unregisterCallback("DMGTYPES", update);
				end
				function update(bReadOnly, bForceHide)
					local nodeRecord = window.getDatabaseNode();
					local bReadOnly = WindowManager.getReadOnlyState(nodeRecord);
					local bDmgTypes = OptionsManagerCypher.replaceArmorWithDamageTypes();
					local bShow = getWindowCount() ~= 0;

					bForceHide = bForceHide or not bDmgTypes or (bReadOnly and not bShow)
					bReadOnly = bForceHide or bReadOnly;

					super.update(bReadOnly, bForceHide);
				end
			</script>
			<datasource>.resistances</datasource>
			<class>damage_modification</class>
			<child merge="delete" />
			<sortby merge="delete" />
		</list_column>
	</template>

	<template name="number_column_armor">
		<number_columnh name="armor">
			<script>
				function onInit()
					if super and super.onInit then
						super.onInit()
					end
					OptionsManager.registerCallback("DMGTYPES", update);
					update();
				end
				function onClose()
					if super and super.onClose then
						super.onClose()
					end
					OptionsManager.unregisterCallback("DMGTYPES", update);
				end
				function update(bReadOnly, bForceHide)
					local bDmgTypes = OptionsManagerCypher.replaceArmorWithDamageTypes();
					local bReadOnlyState = WindowManager.getReadOnlyState(nodeRecord);
					super.update(bReadOnlyState or bReadOnly, bDmgTypes or bForceHide);
				end
			</script>
		</number_columnh>
	</template>

	<template name="stringu_damagetype_autocomplete">
		<stringu>
			<script file="common/scripts/string_damagetype_autocomplete.lua" />
		</stringu>
	</template >
</root>